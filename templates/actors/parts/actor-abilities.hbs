<section class="card">
  <h2>Abilities & Essences</h2>

  <div class="essence-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">

    {{!-- Essence 1 --}}
    <div class="essence-col" data-essence-key="e1" style="border:2px solid #000; border-radius:8px; padding:10px;">
      <div class="flexrow" style="align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">Essence 1</h3>
        <small>(must be distinct)</small>
      </div>

      <div class="drop-slot essence-drop"
           data-drop-type="essence"
           data-essence-key="e1"
           style="margin-top:8px; padding:8px; border:2px dashed #999; border-radius:6px; min-height:52px; display:flex; align-items:center; gap:8px;">
        {{#if system.essencesView.e1.itemId}}
          <img class="essence-img" src="{{system.essencesView.e1.img}}" width="32" height="32" alt="" />
          <div class="essence-name" style="flex:1; font-weight:600;">
            {{system.essencesView.e1.name}}
          </div>
          <a class="essence-edit" data-essence-key="e1" title="Open"><i class="fas fa-edit"></i></a>
          <a class="essence-clear" data-essence-key="e1" title="Remove"><i class="fas fa-times"></i></a>
        {{else}}
          <span>Drop an Essence item here</span>
        {{/if}}
      </div>

      <div class="flexrow" style="margin-top:8px; align-items:center; gap:6px;">
        <label style="white-space:nowrap;">Binds to Attribute:</label>
        <select class="essence-attr-select"
                data-essence-key="e1"
                name="system.essences.e1.attribute"
                style="flex:1;">
          <option value="">—</option>
          <option value="power"    {{#if (eq system.essencesView.e1.attribute "power")}}selected{{/if}}>Power</option>
          <option value="speed"    {{#if (eq system.essencesView.e1.attribute "speed")}}selected{{/if}}>Speed</option>
          <option value="spirit"   {{#if (eq system.essencesView.e1.attribute "spirit")}}selected{{/if}}>Spirit</option>
          <option value="recovery" {{#if (eq system.essencesView.e1.attribute "recovery")}}selected{{/if}}>Recovery</option>
        </select>
      </div>

      <div class="essence-abilities" style="margin-top:10px;">
        {{#each (array 0 1 2 3 4) as |i|}}
          {{#with (lookup system.essencesView.e1.abilities i) as |slot|}}
            <div class="ability-slot item-list"
                 data-essence-key="e1"
                 data-slot-index="{{i}}"
                 style="border:1px solid #000; border-radius:8px; padding:8px; margin-bottom:8px;">

              <div class="drop-slot ability-drop"
                   data-drop-type="essenceAbility"
                   data-essence-key="e1"
                   data-slot-index="{{i}}"
                   style="padding:6px; border:2px dashed #bbb; border-radius:6px; min-height:40px; display:flex; align-items:center; gap:8px;">
                {{#if slot.itemId}}
                  <img class="ability-img" src="{{slot.img}}" width="28" height="28" alt=""/>
                  <a class="ability-edit"
                     data-essence-key="e1"
                     data-slot-index="{{i}}"
                     style="font-weight:600; flex:1;">
                    {{slot.name}}
                  </a>
                  <a class="ability-clear"
                     data-essence-key="e1"
                     data-slot-index="{{i}}"
                     title="Remove"><i class="fas fa-times"></i></a>
                {{else}}
                  <span>Drop an Essence Ability here</span>
                {{/if}}
              </div>

              <div class="flexrow" style="align-items:center; gap:8px; margin-top:6px;">
                <label style="width:50px;">Score</label>
                <input type="number"
                       class="ability-score"
                       data-essence-key="e1"
                       data-slot-index="{{i}}"
                       name="system.essences.e1.abilities.{{i}}.score"
                       value="{{slot.score}}"
                       min="0" />

                <label class="checkbox">
                  <input type="checkbox"
                         class="ability-active"
                         data-essence-key="e1"
                         data-slot-index="{{i}}"
                         name="system.essences.e1.abilities.{{i}}.isActive"
                         {{#if slot.isActive}}checked{{/if}}/>
                  Active
                </label>

                {{#if slot.isActive}}
                  <label class="checkbox">
                    <input type="checkbox"
                           class="ability-attack"
                           data-essence-key="e1"
                           data-slot-index="{{i}}"
                           name="system.essences.e1.abilities.{{i}}.isAttack"
                           {{#if slot.isAttack}}checked{{/if}}/>
                    Attack Ability
                  </label>
                  {{#if slot.isAttack}}
                    <button type="button"
                            class="ability-roll"
                            data-essence-key="e1"
                            data-slot-index="{{i}}"
                            title="Roll">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  {{/if}}
                {{/if}}
              </div>
            </div>
          {{/with}}
        {{/each}}
      </div>
    </div>

    {{!-- Essence 2 --}}
    <div class="essence-col" data-essence-key="e2" style="border:2px solid #000; border-radius:8px; padding:10px;">
      <div class="flexrow" style="align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">Essence 2</h3>
        <small>(must be distinct)</small>
      </div>

      <div class="drop-slot essence-drop"
           data-drop-type="essence" data-essence-key="e2"
           style="margin-top:8px; padding:8px; border:2px dashed #999; border-radius:6px; min-height:52px; display:flex; align-items:center; gap:8px;">
        {{#if system.essencesView.e2.itemId}}
          <img class="essence-img" src="{{system.essencesView.e2.img}}" width="32" height="32" alt="" />
          <div class="essence-name" style="flex:1; font-weight:600;">{{system.essencesView.e2.name}}</div>
          <a class="essence-edit" data-essence-key="e2" title="Open"><i class="fas fa-edit"></i></a>
          <a class="essence-clear" data-essence-key="e2" title="Remove"><i class="fas fa-times"></i></a>
        {{else}}
          <span>Drop an Essence item here</span>
        {{/if}}
      </div>

      <div class="flexrow" style="margin-top:8px; align-items:center; gap:6px;">
        <label style="white-space:nowrap;">Binds to Attribute:</label>
        <select class="essence-attr-select"
                data-essence-key="e2"
                name="system.essences.e2.attribute"
                style="flex:1;">
          <option value="">—</option>
          <option value="power"    {{#if (eq system.essencesView.e2.attribute "power")}}selected{{/if}}>Power</option>
          <option value="speed"    {{#if (eq system.essencesView.e2.attribute "speed")}}selected{{/if}}>Speed</option>
          <option value="spirit"   {{#if (eq system.essencesView.e2.attribute "spirit")}}selected{{/if}}>Spirit</option>
          <option value="recovery" {{#if (eq system.essencesView.e2.attribute "recovery")}}selected{{/if}}>Recovery</option>
        </select>
      </div>

      <div class="essence-abilities" style="margin-top:10px;">
        {{#each (array 0 1 2 3 4) as |i|}}
          {{#with (lookup system.essencesView.e2.abilities i) as |slot|}}
            <div class="ability-slot item-list"
                 data-essence-key="e2"
                 data-slot-index="{{i}}"
                 style="border:1px solid #000; border-radius:8px; padding:8px; margin-bottom:8px;">
              <div class="drop-slot ability-drop"
                   data-drop-type="essenceAbility"
                   data-essence-key="e2"
                   data-slot-index="{{i}}"
                   style="padding:6px; border:2px dashed #bbb; border-radius:6px; min-height:40px; display:flex; align-items:center; gap:8px;">
                {{#if slot.itemId}}
                  <img class="ability-img" src="{{slot.img}}" width="28" height="28" alt=""/>
                  <a class="ability-edit" data-essence-key="e2" data-slot-index="{{i}}" style="font-weight:600; flex:1;">
                    {{slot.name}}
                  </a>
                  <a class="ability-clear" data-essence-key="e2" data-slot-index="{{i}}"><i class="fas fa-times"></i></a>
                {{else}}
                  <span>Drop an Essence Ability here</span>
                {{/if}}
              </div>
              <div class="flexrow" style="align-items:center; gap:8px; margin-top:6px;">
                <label style="width:50px;">Score</label>
                <input type="number"
                       class="ability-score"
                       data-essence-key="e2"
                       data-slot-index="{{i}}"
                       name="system.essences.e2.abilities.{{i}}.score"
                       value="{{slot.score}}"
                       min="0" />
                <label class="checkbox">
                  <input type="checkbox"
                         class="ability-active"
                         data-essence-key="e2"
                         data-slot-index="{{i}}"
                         name="system.essences.e2.abilities.{{i}}.isActive"
                         {{#if slot.isActive}}checked{{/if}}/>
                  Active
                </label>
                {{#if slot.isActive}}
                  <label class="checkbox">
                    <input type="checkbox"
                           class="ability-attack"
                           data-essence-key="e2"
                           data-slot-index="{{i}}"
                           name="system.essences.e2.abilities.{{i}}.isAttack"
                           {{#if slot.isAttack}}checked{{/if}}/>
                    Attack Ability
                  </label>
                  {{#if slot.isAttack}}
                    <button type="button" class="ability-roll" data-essence-key="e2" data-slot-index="{{i}}">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  {{/if}}
                {{/if}}
              </div>
            </div>
          {{/with}}
        {{/each}}
      </div>
    </div>

    {{!-- Essence 3 --}}
    <div class="essence-col" data-essence-key="e3" style="border:2px solid #000; border-radius:8px; padding:10px;">
      <div class="flexrow" style="align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">Essence 3</h3>
        <small>(must be distinct)</small>
      </div>

      <div class="drop-slot essence-drop" data-drop-type="essence" data-essence-key="e3"
           style="margin-top:8px; padding:8px; border:2px dashed #999; border-radius:6px; min-height:52px; display:flex; align-items:center; gap:8px;">
        {{#if system.essencesView.e3.itemId}}
          <img class="essence-img" src="{{system.essencesView.e3.img}}" width="32" height="32" alt="" />
          <div class="essence-name" style="flex:1; font-weight:600;">{{system.essencesView.e3.name}}</div>
          <a class="essence-edit" data-essence-key="e3" title="Open"><i class="fas fa-edit"></i></a>
          <a class="essence-clear" data-essence-key="e3" title="Remove"><i class="fas fa-times"></i></a>
        {{else}}
          <span>Drop an Essence item here</span>
        {{/if}}
      </div>

      <div class="flexrow" style="margin-top:8px; align-items:center; gap:6px;">
        <label style="white-space:nowrap;">Binds to Attribute:</label>
        <select class="essence-attr-select"
                data-essence-key="e3"
                name="system.essences.e3.attribute"
                style="flex:1;">
          <option value="">—</option>
          <option value="power"    {{#if (eq system.essencesView.e3.attribute "power")}}selected{{/if}}>Power</option>
          <option value="speed"    {{#if (eq system.essencesView.e3.attribute "speed")}}selected{{/if}}>Speed</option>
          <option value="spirit"   {{#if (eq system.essencesView.e3.attribute "spirit")}}selected{{/if}}>Spirit</option>
          <option value="recovery" {{#if (eq system.essencesView.e3.attribute "recovery")}}selected{{/if}}>Recovery</option>
        </select>
      </div>

      <div class="essence-abilities" style="margin-top:10px;">
        {{#each (array 0 1 2 3 4) as |i|}}
          {{#with (lookup system.essencesView.e3.abilities i) as |slot|}}
            <div class="ability-slot item-list"
                 data-essence-key="e3"
                 data-slot-index="{{i}}"
                 style="border:1px solid #000; border-radius:8px; padding:8px; margin-bottom:8px;">
              <div class="drop-slot ability-drop"
                   data-drop-type="essenceAbility"
                   data-essence-key="e3"
                   data-slot-index="{{i}}"
                   style="padding:6px; border:2px dashed #bbb; border-radius:6px; min-height:40px; display:flex; align-items:center; gap:8px;">
                {{#if slot.itemId}}
                  <img class="ability-img" src="{{slot.img}}" width="28" height="28" alt=""/>
                  <a class="ability-edit" data-essence-key="e3" data-slot-index="{{i}}" style="font-weight:600; flex:1;">
                    {{slot.name}}
                  </a>
                  <a class="ability-clear" data-essence-key="e3" data-slot-index="{{i}}"><i class="fas fa-times"></i></a>
                {{else}}
                  <span>Drop an Essence Ability here</span>
                {{/if}}
              </div>
              <div class="flexrow" style="align-items:center; gap:8px; margin-top:6px;">
                <label style="width:50px;">Score</label>
                <input type="number"
                       class="ability-score"
                       data-essence-key="e3"
                       data-slot-index="{{i}}"
                       name="system.essences.e3.abilities.{{i}}.score"
                       value="{{slot.score}}"
                       min="0" />
                <label class="checkbox">
                  <input type="checkbox"
                         class="ability-active"
                         data-essence-key="e3"
                         data-slot-index="{{i}}"
                         name="system.essences.e3.abilities.{{i}}.isActive"
                         {{#if slot.isActive}}checked{{/if}}/>
                  Active
                </label>
                {{#if slot.isActive}}
                  <label class="checkbox">
                    <input type="checkbox"
                           class="ability-attack"
                           data-essence-key="e3"
                           data-slot-index="{{i}}"
                           name="system.essences.e3.abilities.{{i}}.isAttack"
                           {{#if slot.isAttack}}checked{{/if}}/>
                    Attack Ability
                  </label>
                  {{#if slot.isAttack}}
                    <button type="button" class="ability-roll" data-essence-key="e3" data-slot-index="{{i}}">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  {{/if}}
                {{/if}}
              </div>
            </div>
          {{/with}}
        {{/each}}
      </div>
    </div>

    {{!-- Confluence --}}
    <div class="essence-col" data-essence-key="confluence" style="border:2px solid #000; border-radius:8px; padding:10px;">
      <div class="flexrow" style="align-items:center; justify-content:space-between;">
        <h3 style="margin:0;">Confluence</h3>
        <small>(derived from 1–3)</small>
      </div>

      <div class="drop-slot essence-drop"
           data-drop-type="essence"
           data-essence-key="confluence"
           style="margin-top:8px; padding:8px; border:2px dashed #999; border-radius:6px; min-height:52px; display:flex; align-items:center; gap:8px;">
        {{#if system.essencesView.confluence.itemId}}
          <img class="essence-img" src="{{system.essencesView.confluence.img}}" width="32" height="32" alt="" />
          <div class="essence-name" style="flex:1; font-weight:600;">{{system.essencesView.confluence.name}}</div>
          <a class="essence-edit" data-essence-key="confluence" title="Open"><i class="fas fa-edit"></i></a>
          <a class="essence-clear" data-essence-key="confluence" title="Remove"><i class="fas fa-times"></i></a>
        {{else}}
          <span>Drop a Confluence Essence here</span>
        {{/if}}
      </div>

      <div class="flexrow" style="margin-top:8px; align-items:center; gap:6px;">
        <label style="white-space:nowrap;">Binds to Attribute:</label>
        <select class="essence-attr-select"
                data-essence-key="confluence"
                name="system.essences.confluence.attribute"
                style="flex:1;">
          <option value="">—</option>
          <option value="power"    {{#if (eq system.essencesView.confluence.attribute "power")}}selected{{/if}}>Power</option>
          <option value="speed"    {{#if (eq system.essencesView.confluence.attribute "speed")}}selected{{/if}}>Speed</option>
          <option value="spirit"   {{#if (eq system.essencesView.confluence.attribute "spirit")}}selected{{/if}}>Spirit</option>
          <option value="recovery" {{#if (eq system.essencesView.confluence.attribute "recovery")}}selected{{/if}}>Recovery</option>
        </select>
      </div>

      <div class="essence-abilities" style="margin-top:10px;">
        {{#each (array 0 1 2 3 4) as |i|}}
          {{#with (lookup system.essencesView.confluence.abilities i) as |slot|}}
            <div class="ability-slot item-list"
                 data-essence-key="confluence"
                 data-slot-index="{{i}}"
                 style="border:1px solid #000; border-radius:8px; padding:8px; margin-bottom:8px;">
              <div class="drop-slot ability-drop"
                   data-drop-type="essenceAbility"
                   data-essence-key="confluence"
                   data-slot-index="{{i}}"
                   style="padding:6px; border:2px dashed #bbb; border-radius:6px; min-height:40px; display:flex; align-items:center; gap:8px;">
                {{#if slot.itemId}}
                  <img class="ability-img" src="{{slot.img}}" width="28" height="28" alt=""/>
                  <a class="ability-edit" data-essence-key="confluence" data-slot-index="{{i}}" style="font-weight:600; flex:1;">
                    {{slot.name}}
                  </a>
                  <a class="ability-clear" data-essence-key="confluence" data-slot-index="{{i}}"><i class="fas fa-times"></i></a>
                {{else}}
                  <span>Drop an Essence Ability here</span>
                {{/if}}
              </div>
              <div class="flexrow" style="align-items:center; gap:8px; margin-top:6px;">
                <label style="width:50px;">Score</label>
                <input type="number"
                       class="ability-score"
                       data-essence-key="confluence"
                       data-slot-index="{{i}}"
                       name="system.essences.confluence.abilities.{{i}}.score"
                       value="{{slot.score}}"
                       min="0" />
                <label class="checkbox">
                  <input type="checkbox"
                         class="ability-active"
                         data-essence-key="confluence"
                         data-slot-index="{{i}}"
                         name="system.essences.confluence.abilities.{{i}}.isActive"
                         {{#if slot.isActive}}checked{{/if}}/>
                  Active
                </label>
                {{#if slot.isActive}}
                  <label class="checkbox">
                    <input type="checkbox"
                           class="ability-attack"
                           data-essence-key="confluence"
                           data-slot-index="{{i}}"
                           name="system.essences.confluence.abilities.{{i}}.isAttack"
                           {{#if slot.isAttack}}checked{{/if}}/>
                    Attack Ability
                  </label>
                  {{#if slot.isAttack}}
                    <button type="button" class="ability-roll" data-essence-key="confluence" data-slot-index="{{i}}">
                      <i class="fas fa-dice-d20"></i>
                    </button>
                  {{/if}}
                {{/if}}
              </div>
            </div>
          {{/with}}
        {{/each}}
      </div>
    </div>

  </div>

  {{!-- Racial Abilities --}}
  <div class="racial-block" style="margin-top:16px;">
    <h3>Racial Abilities</h3>
    <p style="margin:0 0 8px;">Up to 6 abilities (auto-populated from Race items on the sheet).</p>

    <div class="racial-abilities" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
      {{#each actor.items as |it|}}
        {{#if (eq it.type "racialAbility")}}
          <div class="racial-item item" data-item-id="{{it._id}}"
               style="border:1px solid #000; border-radius:8px; padding:8px; display:flex; gap:8px; align-items:center;">
            <img src="{{it.img}}" width="32" height="32" alt=""/>
            <div style="flex:1;">
              <div style="font-weight:600;">{{it.name}}</div>
              <div class="notes" style="font-size:12px; opacity:0.8;">{{it.system.summary}}{{it.system.notes}}</div>
            </div>
            <a class="item-edit" title="Open"><i class="fas fa-edit"></i></a>
          </div>
        {{/if}}
      {{/each}}
    </div>
  </div>
</section>
